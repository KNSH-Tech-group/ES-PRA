<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·¡è˜­è©¦ç…‰è¿·å®®ï¼šå¾ªåºçµæ§‹</title>
    
    <style>
        /* æ–°å¢/ä¿®æ”¹çš„æ ¸å¿ƒ CSSï¼Œå¯¦ç¾å·¦å³ä½ˆå±€ */
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 20px;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .game-container {
            max-width: 1200px; 
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .game-title {
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .game-subtitle {
            text-align: center;
            font-size: 16px;
            color: #718096;
            margin-bottom: 30px;
        }

        /* é—œéµï¼šæ–°çš„ Flex å®¹å™¨å¯¦ç¾å·¦å³åˆ†æ¬„ */
        .main-content-wrapper {
            display: flex;
            gap: 30px; 
            /* è®“å·¦å³å…©æ¬„é«˜åº¦åŒæ­¥ */
            flex-wrap: wrap; 
            justify-content: center;
        }
        
        /* è¿·å®®å€å¡Š */
        .maze-container {
            flex-shrink: 0;
            margin-bottom: 0; 
        }

        /* æŒ‡ä»¤èˆ‡æ§åˆ¶å€å¡Š */
        .controls-area-wrapper {
            flex-grow: 1; 
            min-width: 350px; 
        }
        
        .maze-grid {
            display: grid;
            grid-template-columns: repeat(4, 80px);
            grid-template-rows: repeat(4, 80px);
            gap: 2px;
            /* è¿·å®®èƒŒæ™¯åœ–ç‰‡ */
            background-image: url("./03.png"); 
            background-size: cover; 
            background-position: center;
            padding: 10px;
            border-radius: 10px;
        }

        .maze-cell {
            /* èƒŒæ™¯æ”¹ç‚ºé€æ˜ */
            background: transparent; 
            /* ä¿®æ­£ç‚ºç™½è‰²é‚Šæ¡† */
            border: 2px solid #FFF; 
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            font-size: 24px;
        }

        /* --- åœ–ç‰‡æ¨£å¼ä¿®æ”¹ --- */
        .character-img, .treasure-img {
            max-width: 72%; 
            max-height: 72%;
            transition: transform 0.3s ease;
            object-fit: contain; 
        }
        
        /* â­ START: ç‚ºäº†æ—‹è½‰è€Œä¿®æ”¹çš„ CSS â­ */
        .character {
            position: absolute; 
            /* æ ¸å¿ƒè®Šæ•¸ï¼Œç”¨æ–¼æ§åˆ¶æ—‹è½‰è§’åº¦ */
            transform: rotate(var(--rotation-deg, 0deg)); 
            /* è®“æ—‹è½‰çœ‹èµ·ä¾†å¹³æ»‘ */
            transition: transform 0.3s ease-out; 
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        /* â­ END: ç‚ºäº†æ—‹è½‰è€Œä¿®æ”¹çš„ CSS â­ */

        .treasure {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        /* --- åœ–ç‰‡æ¨£å¼ä¿®æ”¹çµæŸ --- */


        .direction-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 12px;
            z-index: 10;
        }

        .controls-section {
            margin-bottom: 20px; 
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #4a5568;
        }

        .command-tokens {
            display: flex;
            gap: 15px;
            justify-content: flex-start; 
            margin-bottom: 20px;
        }

        .command-token {
            width: 60px; 
            height: 60px; 
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: grab;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
            transition: all 0.2s ease;
            border: 3px solid transparent;
        }

        .command-token:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .command-token:active {
            cursor: grabbing;
            transform: scale(0.95);
        }

        .token-a { background: #48bb78; color: white; }
        .token-b { background: #ed8936; color: white; }
        .token-c { background: #4299e1; color: white; }

        .sequence-area {
            min-height: 60px; 
            border: 3px dashed #cbd5e0;
            border-radius: 15px;
            padding: 10px; 
            background: #f7fafc;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .sequence-area.drag-over {
            border-color: #4299e1;
            background: #ebf8ff;
        }

        .sequence-token {
            width: 50px; 
            height: 50px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            position: relative;
        }

        .sequence-token .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .game-controls {
            display: flex;
            /* === ä¿®æ­£: èª¿æ•´é–“éš”ï¼Œè®“ HOME æŒ‰éˆ•æœ‰ç©ºé–“ === */
            gap: 15px; 
            justify-content: flex-start; 
            align-items: center;
            margin-bottom: 0; 
        }

        .btn {
            padding: 8px 24px; 
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #4299e1;
            color: white;
        }

        .btn-primary:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .btn-secondary:hover {
            background: #4a5568;
            transform: translateY(-2px);
        }
        
        /* === æ–°å¢ HOME æŒ‰éˆ•æ¨£å¼ === */
        .btn-home {
            background: #DCDCDC; /* ç™½è‰² */
            color: white;
        }
        
        .btn-home:hover {
            background: #DCDCDC;
            transform: translateY(-2px);
        }
        /* === çµæŸ HOME æŒ‰éˆ•æ¨£å¼ === */


        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .status-area {
            display: flex;
            /* === ä¿®æ­£: è®“æŒ‰éˆ•å®¹å™¨çš„å…§å®¹é å·¦å°é½Š === */
            justify-content: flex-start; 
            align-items: center;
            background: transparent; 
            padding: 0; 
            border-radius: 0; 
            margin-bottom: 20px;
        }

        .result-message {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-top: 0; 
            min-height: 20px;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            border: 2px solid #48bb78;
        }

        .failure {
            background: #fed7d7;
            color: #742a2a;
            border: 2px solid #e53e3e;
        }

        .empty-sequence {
            color: #a0aec0;
            font-style: italic;
            text-align: center;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="game-title" id="gameTitle">æ·¡è˜­è©¦ç…‰è¿·å®®ï¼šå¾ªåºçµæ§‹</h1>
        <p class="game-subtitle">è«‹åˆ©ç”¨ä¸‹åˆ— 3 ç¨®æŒ‡ä»¤ç‰Œï¼Œå¼•å°<span id="characterName"> å°æ–° </span>å–å¾—å¯¶è—ã€‚</p>
        
        <div class="main-content-wrapper">
        
            <div class="maze-container">
                <div class="maze-grid" id="mazeGrid">
                    </div>
            </div>
            
            <div class="controls-area-wrapper">
                <div class="controls-section">
                    <div class="section-title">å¯ç”¨æŒ‡ä»¤ç‰Œ</div>
                    <div class="command-tokens">
                        <div class="command-token token-a" draggable="true" data-command="A">
                            <div>A</div>
                            <div>å‰é€²ä¸€æ ¼</div>
                        </div>
                        <div class="command-token token-b" draggable="true" data-command="B">
                            <div>B</div>
                            <div>åŸåœ°å·¦è½‰</div>
                        </div>
                        <div class="command-token token-c" draggable="true" data-command="C">
                            <div>C</div>
                            <div>åŸåœ°å³è½‰</div>
                        </div>
                        </div>
                </div>
                
                <div class="controls-section">
                    <div class="section-title">æŒ‡ä»¤åºåˆ—</div>
                    <div class="sequence-area" id="sequenceArea">
                        <div class="empty-sequence">å°‡æŒ‡ä»¤ç‰Œæ‹–æ›³åˆ°é€™è£¡</div>
                    </div>
                </div>
                
                <div class="status-area">
                    <div class="game-controls">
                        <button class="btn btn-primary" id="executeBtn">åŸ·è¡Œ</button>
                        <button class="btn btn-secondary" id="resetBtn">é‡ç½®</button>
                        <a href="./index.html" class="btn btn-home">ğŸ HOME</a>
                    </div>
                </div>
                <div class="result-message" id="resultMessage"></div>
            </div>
            
        </div>
    </div>
    
    <script>
        // éŠæˆ²ç‹€æ…‹ (Game State)
        let gameState = {
            playerPos: { x: 0, y: 0 }, 
            playerDirection: 1,      
            sequence: [], 
            isExecuting: false,
            gameEnded: false
        };

        // è¿·å®®é…ç½®
        const MAZE_SIZE = 4;
        const TREASURE_POS = { x: 2, y: 3 }; 
        const DIRECTIONS = ['â¬†ï¸', 'â¡ï¸', 'â¬‡ï¸', 'â¬…ï¸'];

        // åœ–ç‰‡ URL ä¿®æ­£ç‚ºç›¸å°è·¯å¾‘
        const ROBOT_IMAGE_URL = "./01.png";
        const TREASURE_IMAGE_URL = ./"02.png";

        // é è¨­é…ç½®
        const defaultConfig = {
            game_title: "æ·¡è˜­è©¦ç…‰è¿·å®®ï¼šå¾ªåºçµæ§‹", 
            character_name: " å°æ–° ",
            success_message: "æ­å–œï¼ å°æ–° æˆåŠŸå–å¾—å¯¶è—ï¼"
        };
        
        // --- æ ¸å¿ƒéŠæˆ²å‡½æ•¸ ---

        function initMaze() {
            const mazeGrid = document.getElementById('mazeGrid');
            
            mazeGrid.innerHTML = '';
            for (let row = 0; row < MAZE_SIZE; row++) {
                for (let col = 0; col < MAZE_SIZE; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'maze-cell';
                    cell.id = `cell-${row}-${col}`;
                    
                    // å¯¶è—åœ–ç‰‡è¨­å®š
                    if (row === TREASURE_POS.x && col === TREASURE_POS.y) {
                        cell.innerHTML = `
                            <span class="treasure">
                                <img src="${TREASURE_IMAGE_URL}" alt="å¯¶è—" class="treasure-img">
                            </span>
                        `;
                    }
                    mazeGrid.appendChild(cell);
                }
            }
            
            document.getElementById('characterName').textContent = defaultConfig.character_name;
            document.getElementById('gameTitle').textContent = defaultConfig.game_title;
            
            updatePlayerPosition();
        }

        // ç‚ºäº†æ—‹è½‰è€Œä¿®æ”¹çš„ JS é‚è¼¯
        function updatePlayerPosition() {
            document.querySelectorAll('.character').forEach(char => char.remove());
            document.querySelectorAll('.direction-indicator').forEach(indicator => indicator.remove());
            
            const cell = document.getElementById(`cell-${gameState.playerPos.x}-${gameState.playerPos.y}`);
            if (cell) {
                const character = document.createElement('span');
                character.className = 'character';
                
                // è¨ˆç®—æ—‹è½‰è§’åº¦
                let rotationDegrees = 0;
                switch (gameState.playerDirection) {
                    case 0: // ä¸Š
                        rotationDegrees = -90;
                        break;
                    case 1: // å³
                        rotationDegrees = 0;
                        break;
                    case 2: // ä¸‹
                        rotationDegrees = 90;
                        break;
                    case 3: // å·¦
                        rotationDegrees = 180;
                        break;
                }
                // å°‡è§’åº¦è¨­ç½®ç‚º CSS è®Šæ•¸
                character.style.setProperty('--rotation-deg', `${rotationDegrees}deg`);


                // è§’è‰²åœ–ç‰‡è¨­å®š
                character.innerHTML = `
                    <img src="${ROBOT_IMAGE_URL}" alt="${defaultConfig.character_name}" class="character-img">
                `; 
                
                const directionIndicator = document.createElement('span');
                directionIndicator.className = 'direction-indicator';
                directionIndicator.textContent = DIRECTIONS[gameState.playerDirection];
                
                cell.appendChild(character);
                cell.appendChild(directionIndicator);
            }
        }
        
        function setupDragAndDrop() {
            const tokens = document.querySelectorAll('.command-token');
            const sequenceArea = document.getElementById('sequenceArea');

            tokens.forEach(token => {
                token.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.dataset.command);
                });
                token.addEventListener('click', (e) => {
                    const command = e.currentTarget.dataset.command;
                    if (command && !gameState.isExecuting) { 
                        addToSequence(command);
                    }
                });
            });

            sequenceArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                sequenceArea.classList.add('drag-over');
            });
            sequenceArea.addEventListener('dragleave', () => {
                sequenceArea.classList.remove('drag-over');
            });
            sequenceArea.addEventListener('drop', (e) => {
                e.preventDefault();
                sequenceArea.classList.remove('drag-over');
                const command = e.dataTransfer.getData('text/plain');
                if (command && !gameState.isExecuting) {
                    addToSequence(command);
                }
            });
        }

        function addToSequence(command) {
            gameState.sequence.push(command);
            updateSequenceDisplay();
        }

        window.removeFromSequence = function(index) {
            if (!gameState.isExecuting) {
                gameState.sequence.splice(index, 1);
                updateSequenceDisplay();
            }
        }

        function updateSequenceDisplay() {
            const sequenceArea = document.getElementById('sequenceArea');
            if (gameState.sequence.length === 0) {
                sequenceArea.innerHTML = '<div class="empty-sequence">å°‡æŒ‡ä»¤ç‰Œæ‹–æ›³åˆ°é€™è£¡</div>';
                return;
            }

            sequenceArea.innerHTML = '';
            gameState.sequence.forEach((command, index) => {
                const commandText = {
                    'A': 'å‰é€²ä¸€æ ¼',
                    'B': 'åŸåœ°å·¦è½‰', 
                    'C': 'åŸåœ°å³è½‰' 
                };
                
                const token = document.createElement('div');
                token.className = `sequence-token token-${command.toLowerCase()}`;
                token.innerHTML = `
                    <div>${command}</div>
                    <div style="font-size: 10px;">${commandText[command]}</div>
                    <button class="remove-btn" onclick="removeFromSequence(${index})">Ã—</button>
                `;
                sequenceArea.appendChild(token);
            });
        }
        
        // ----------------------------------------------------
        // æ ¸å¿ƒé‚è¼¯: å¾ªåºåŸ·è¡Œ (A å‰é€², B å·¦è½‰, C å³è½‰)
        // ----------------------------------------------------
        
        function isValidPosition(x, y) {
            return x >= 0 && x < MAZE_SIZE && y >= 0 && y < MAZE_SIZE;
        }

        function getFrontPosition() {
            const directions = [
                { x: -1, y: 0 }, // ä¸Š
                { x: 0, y: 1 },  // å³
                { x: 1, y: 0 },  // ä¸‹
                { x: 0, y: -1 }  // å·¦
            ];
            const dir = directions[gameState.playerDirection];
            return {
                x: gameState.playerPos.x + dir.x,
                y: gameState.playerPos.y + dir.y
            };
        }
        
        // åŸ·è¡Œå–®å€‹æŒ‡ä»¤ (ééè¿´)
        async function executeCommand(command) {
             return new Promise(resolve => {
                 setTimeout(() => {
                     if (gameState.gameEnded) {
                          resolve();
                          return;
                     }
                    
                     switch (command) {
                         case 'A': // å‰é€²ä¸€æ ¼
                             const frontPos = getFrontPosition();
                             if (isValidPosition(frontPos.x, frontPos.y)) {
                                 gameState.playerPos = frontPos;
                             } else {
                                 gameState.gameEnded = true;
                                 showResult(false, "è¶…å‡ºè¿·å®®é‚Šç•Œï¼");
                             }
                             break;
                         case 'B': // åŸåœ°å·¦è½‰
                             gameState.playerDirection = (gameState.playerDirection + 3) % 4;
                             break;
                         case 'C': // åŸåœ°å³è½‰
                             gameState.playerDirection = (gameState.playerDirection + 1) % 4;
                             break;
                     }
                    
                     updatePlayerPosition();
                    
                     if (gameState.playerPos.x === TREASURE_POS.x && gameState.playerPos.y === TREASURE_POS.y) {
                         gameState.gameEnded = true;
                         const config = window.elementSdk?.config || defaultConfig;
                         showResult(true, config.success_message || defaultConfig.success_message);
                     }
                    
                     resolve();
                 }, 500); // æ¯æ¬¡æ“ä½œå»¶é² 500ms
             });
        }
        
        // åŸ·è¡Œåºåˆ—
        async function executeSequence() {
            if (gameState.sequence.length === 0 || gameState.isExecuting) return;
            
            gameState.isExecuting = true;
            document.getElementById('executeBtn').disabled = true;
            document.getElementById('resultMessage').textContent = '';
            document.getElementById('resultMessage').className = 'result-message';
            
            for (let i = 0; i < gameState.sequence.length && !gameState.gameEnded; i++) {
                await executeCommand(gameState.sequence[i]);
            }
            
            gameState.isExecuting = false;
            document.getElementById('executeBtn').disabled = false;
            
            if (!gameState.gameEnded) {
                showResult(false, "é‚„æ²’åˆ°é”å¯¶è—ï¼Œè©¦è©¦èª¿æ•´æŒ‡ä»¤åºåˆ—ï¼");
            }
        }

        function showResult(success, message) {
            const resultDiv = document.getElementById('resultMessage');
            resultDiv.textContent = message;
            resultDiv.className = `result-message ${success ? 'success' : 'failure'}`;
        }

        function resetGame() {
            gameState = {
                playerPos: { x: 0, y: 0 },
                playerDirection: 1,
                sequence: [],
                isExecuting: false,
                gameEnded: false
            };
            
            updatePlayerPosition();
            updateSequenceDisplay();
            document.getElementById('resultMessage').textContent = '';
            document.getElementById('resultMessage').className = 'result-message';
            document.getElementById('executeBtn').disabled = false;
        }

        // --- äº‹ä»¶ç›£è½å™¨èˆ‡åˆå§‹åŒ– ---
        document.getElementById('executeBtn').addEventListener('click', executeSequence);
        document.getElementById('resetBtn').addEventListener('click', resetGame);

        document.addEventListener('DOMContentLoaded', () => {
            initMaze();
            setupDragAndDrop();
        });
    </script>
</body>
</html>
