<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·¡è˜­è©¦ç…‰è¿·å®®ï¼šé¸æ“‡çµæ§‹</title>
    
    <style>
        /* CSS æ¨£å¼å®šç¾© */
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 20px;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .game-container {
            max-width: 1200px; 
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .game-title {
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .game-subtitle {
            text-align: center;
            font-size: 16px;
            color: #718096;
            margin-bottom: 30px;
        }

        .main-content-wrapper {
            display: flex;
            gap: 30px; 
            flex-wrap: wrap; 
            justify-content: center;
        }
        
        .maze-container {
            flex-shrink: 0;
            margin-bottom: 0; 
        }

        .controls-area-wrapper {
            flex-grow: 1; 
            min-width: 350px; 
        }
        
        .maze-grid {
            display: grid;
            grid-template-columns: repeat(4, 80px);
            grid-template-rows: repeat(4, 80px);
            gap: 2px;
            background-image: url("03.png"); 
            background-size: cover; 
            background-position: center;
            padding: 10px;
            border-radius: 10px;
        }

        .maze-cell {
            background: transparent; 
            border: 2px solid #FFF; 
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            font-size: 24px;
        }
        
        .trap-img {
            max-width: 65%; 
            max-height: 65%;
            object-fit: contain;
            opacity: 0.8;
        }

        .character-img {
            max-width: 60%; 
            max-height: 60%;
            transition: transform 0.3s ease; 
            object-fit: contain; 
        }
        
        .treasure-img {
            max-width: 70%; 
            max-height: 70%; 
            transition: transform 0.3s ease;
            object-fit: contain; 
        }
        
        .character {
            position: absolute;
	    transform: translate(15%, 0%);
        }

        .treasure {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 95%;
            height: 95%;
        }

        .direction-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 12px;
            display: block;
        }

        .controls-section {
            margin-bottom: 20px; 
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #4a5568;
        }

        .command-tokens {
            display: flex;
            gap: 15px;
            justify-content: flex-start; 
            margin-bottom: 20px;
        }

        .command-token {
            width: 70px; 
            height: 70px; 
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: grab;
            font-weight: bold;
            font-size: 12px; 
            text-align: center;
            transition: all 0.2s ease;
            border: 3px solid transparent;
            line-height: 1.2; 
        }

        .command-token:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .command-token:active {
            cursor: grabbing;
            transform: scale(0.95);
        }
        
        .token-a { background: #48bb78; color: white; } 
        .token-b { background: #ed8936; color: white; } 
        .token-c { background: #4299e1; color: white; } 
        .token-d { background: #9f7aea; color: white; } 


        .sequence-area {
            min-height: 60px; 
            border: 3px dashed #cbd5e0;
            border-radius: 15px;
            padding: 10px; 
            background: #f7fafc;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .sequence-area.drag-over {
            border-color: #4299e1;
            background: #ebf8ff;
        }

        .sequence-token {
            width: 50px; 
            height: 50px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 10px; 
            cursor: pointer;
            position: relative;
            line-height: 1.2;
        }

        .sequence-token .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .game-controls {
            display: flex;
            gap: 15px;
            justify-content: flex-start; 
            align-items: center;
            margin-bottom: 0; 
        }

        .btn {
            padding: 8px 24px; 
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #4299e1;
            color: white;
        }

        .btn-primary:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .btn-secondary:hover {
            background: #4a5568;
            transform: translateY(-2px);
        }


        /* === æ–°å¢ HOME æŒ‰éˆ•æ¨£å¼ === */
        .btn-home {
            background: #DCDCDC; /* ç™½è‰² */
            color: white;
        }
        
        .btn-home:hover {
            background: #DCDCDC;
            transform: translateY(-2px);
        }
        /* === çµæŸ HOME æŒ‰éˆ•æ¨£å¼ === */



        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .status-area {
            display: flex;
            justify-content: flex-start; 
            align-items: center;
            background: transparent; 
            padding: 0; 
            border-radius: 0; 
            margin-bottom: 20px;
        }

        .result-message {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-top: 0; 
            min-height: 20px;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            border: 2px solid #48bb78;
        }

        .failure {
            background: #fed7d7;
            color: #742a2a;
            border: 2px solid #e53e3e;
        }

        .empty-sequence {
            color: #a0aec0;
            font-style: italic;
            text-align: center;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="game-title" id="gameTitle">æ·¡è˜­è©¦ç…‰è¿·å®®ï¼šé¸æ“‡çµæ§‹</h1>
        <p class="game-subtitle">è«‹åˆ©ç”¨ä¸‹åˆ— 4 ç¨®æŒ‡ä»¤ç‰Œï¼Œå¼•å°<span id="characterName"> å°æ–° </span>å–å¾—å¯¶è—ã€‚</p>
        
        <div class="main-content-wrapper">
        
            <div class="maze-container">
                <div class="maze-grid" id="mazeGrid">
                    </div>
            </div>
            
            <div class="controls-area-wrapper">
                <div class="controls-section">
                    <div class="section-title">å¯ç”¨æŒ‡ä»¤ç‰Œ</div>
                    <div class="command-tokens">
                        <div class="command-token token-a" draggable="true" data-command="A">
                            <div>A</div>
                            <div>å‰é€²ä¸€æ ¼</div>
                        </div>
                        <div class="command-token token-b" draggable="true" data-command="B">
                            <div>B</div>
                            <div>åŸåœ°å·¦è½‰</div>
                        </div>
                        <div class="command-token token-c" draggable="true" data-command="C">
                            <div>C</div>
                            <div>å‰é€²ï¼›è‹¥å‰æ–¹æ²’è·¯å°±å·¦è½‰</div>
                        </div>
                        <div class="command-token token-d" draggable="true" data-command="D">
                            <div>D</div>
                            <div>å‰é€²ï¼›è‹¥å‰æ–¹æ²’è·¯å°±å³è½‰</div>
                        </div>
                    </div>
                </div>
                
                <div class="controls-section">
                    <div class="section-title">æŒ‡ä»¤åºåˆ—</div>
                    <div class="sequence-area" id="sequenceArea">
                        <div class="empty-sequence">å°‡æŒ‡ä»¤ç‰Œæ‹–æ›³åˆ°é€™è£¡</div>
                    </div>
                </div>
                
                <div class="status-area">
                    <div class="game-controls">
                        <button class="btn btn-primary" id="executeBtn">åŸ·è¡Œ</button>
                        <button class="btn btn-secondary" id="resetBtn">é‡ç½®</button>
                        <a href="index.html" class="btn btn-home">ğŸ HOME</a>

                    </div>
                </div>
                <div class="result-message" id="resultMessage"></div>
            </div>
            
        </div>
    </div>
    
    <script>
        // éŠæˆ²ç‹€æ…‹ (Game State)
        let gameState = {
            // 1. ä¸»è§’åº§æ¨™(2,3)
            playerPos: { x: 2, y: 3 }, 
            // 1. é¢æœå·¦ (å°æ‡‰ DIRECTIONS[3])
            playerDirection: 3,      
            // åˆå§‹æ—‹è½‰ 0 åº¦ï¼Œè®“åœ–ç‰‡é¢æœå·¦
            playerRotation: 0, 
            sequence: [], 
            isExecuting: false,
            gameEnded: false
        };

        // è¿·å®®é…ç½®
        const MAZE_SIZE = 4;
        const DIRECTIONS = ['â¬†ï¸', 'â¡ï¸', 'â¬‡ï¸', 'â¬…ï¸'];
        
        const ROBOT_IMAGE_URL = "05.png";
        const TREASURE_IMAGE_URL = "02.png";
        const TRAP_IMAGE_URL = "04.png"; // éšœç¤™ç‰©åœ–ç‰‡

        // 2. å¯¶è—åº§æ¨™(3,1)
        const TREASURE_POS = { x: 3, y: 1 }; 

        // 3. éšœç¤™ç‰©åº§æ¨™æ¸…å–® (5å€‹)
        const TRAPS = [
            { x: 1, y: 0 }, 
            { x: 3, y: 0 }, 
            { x: 2, y: 2 }, 
            { x: 0, y: 3 }, 
            { x: 3, y: 3 }
        ];

        // é è¨­é…ç½®
        const defaultConfig = {
            game_title: "æ·¡è˜­è©¦ç…‰è¿·å®®ï¼šé¸æ“‡çµæ§‹", 
            character_name: " å°æ–° ",
            success_message: "æ­å–œï¼ å°æ–° æˆåŠŸå–å¾—å¯¶è—ï¼"
        };
        
        // åˆ¤æ–·ä¸€å€‹ä½ç½®æ˜¯å¦ç‚ºéšœç¤™ç‰©
        function isObstacle(x, y) {
             return TRAPS.some(trap => trap.x === x && trap.y === y);
        }

        // --- æ ¸å¿ƒéŠæˆ²å‡½æ•¸ ---

        function initMaze() {
            const mazeGrid = document.getElementById('mazeGrid');
            
            mazeGrid.innerHTML = ''; 
            
            for (let row = 0; row < MAZE_SIZE; row++) {
                for (let col = 0; col < MAZE_SIZE; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'maze-cell';
                    cell.id = `cell-${row}-${col}`;
                    
                    // éšœç¤™ç‰©åœ–ç‰‡è¨­å®š
                    if (isObstacle(row, col)) {
                         cell.innerHTML = `<img src="${TRAP_IMAGE_URL}" alt="éšœç¤™ç‰©" class="trap-img">`;
                    }
                    
                    // å¯¶è—åœ–ç‰‡è¨­å®š
                    if (row === TREASURE_POS.x && col === TREASURE_POS.y) {
                         cell.innerHTML = `
                            <span class="treasure">
                                <img src="${TREASURE_IMAGE_URL}" alt="å¯¶è—" class="treasure-img">
                            </span>
                        `;
                    }
                    
                    mazeGrid.appendChild(cell);
                }
            }
            
            document.getElementById('characterName').textContent = defaultConfig.character_name;
            document.getElementById('gameTitle').textContent = defaultConfig.game_title;
            
            // æ”¾ç½®åˆå§‹è§’è‰²
            updatePlayerPosition();
        }

        function updatePlayerPosition() {
            // ç§»é™¤èˆŠçš„è§’è‰²å’Œç®­é ­
            document.querySelectorAll('.character').forEach(char => char.remove());
            document.querySelectorAll('.direction-indicator').forEach(indicator => indicator.remove());
            
            const cell = document.getElementById(`cell-${gameState.playerPos.x}-${gameState.playerPos.y}`);
            if (cell) {
                // ä¸å†æª¢æŸ¥é™·é˜±ï¼Œéšœç¤™ç‰©åƒ…é˜»æ­¢é€šè¡Œ
                const character = document.createElement('span');
                character.className = 'character';
                
                character.innerHTML = `
                    <img src="${ROBOT_IMAGE_URL}" alt="${defaultConfig.character_name}" class="character-img" id="playerImage">
                `; 
                
                // æ ¹æ“š playerRotation æ—‹è½‰åœ–ç‰‡
                const playerImage = character.querySelector('#playerImage');
                if(playerImage) {
                    playerImage.style.transform = `rotate(${gameState.playerRotation}deg)`;
                }

                const directionIndicator = document.createElement('span');
                directionIndicator.className = 'direction-indicator';
                directionIndicator.textContent = DIRECTIONS[gameState.playerDirection]; 
                
                cell.appendChild(character);
                cell.appendChild(directionIndicator);
            }
        }

        // åˆ¤æ–·æ˜¯å¦ç‚ºæœ‰æ•ˆä½ç½®ï¼ˆåœ¨é‚Šç•Œå…§ä¸”ééšœç¤™ç‰©ï¼‰
        function isValidPosition(x, y) {
            // æª¢æŸ¥æ˜¯å¦åœ¨é‚Šç•Œå…§ 
            const inBounds = x >= 0 && x < MAZE_SIZE && y >= 0 && y < MAZE_SIZE;
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºéšœç¤™ç‰©
            if (inBounds && isObstacle(x, y)) {
                return false; // åœ¨é‚Šç•Œå…§ä½†æœ‰éšœç¤™ç‰©ï¼Œè¦–ç‚ºç„¡æ•ˆä½ç½®
            }

            return inBounds; // åœ¨é‚Šç•Œå…§ä¸”ç„¡éšœç¤™ç‰©ï¼Œè¦–ç‚ºæœ‰æ•ˆä½ç½®
        }

        function getFrontPosition() {
            const directions = [
                { x: -1, y: 0 }, // ä¸Š (0)
                { x: 0, y: 1 },  // å³ (1)
                { x: 1, y: 0 },  // ä¸‹ (2)
                { x: 0, y: -1 }  // å·¦ (3)
            ];
            const dir = directions[gameState.playerDirection];
            return {
                x: gameState.playerPos.x + dir.x,
                y: gameState.playerPos.y + dir.y
            };
        }

        function setupDragAndDrop() {
            const tokens = document.querySelectorAll('.command-token');
            const sequenceArea = document.getElementById('sequenceArea');

            tokens.forEach(token => {
                token.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.dataset.command);
                });
                token.addEventListener('click', (e) => {
                    const command = e.currentTarget.dataset.command;
                    if (command && !gameState.isExecuting) { 
                        addToSequence(command);
                    }
                });
            });

            sequenceArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                sequenceArea.classList.add('drag-over');
            });
            sequenceArea.addEventListener('dragleave', () => {
                sequenceArea.classList.remove('drag-over');
            });
            sequenceArea.addEventListener('drop', (e) => {
                e.preventDefault();
                sequenceArea.classList.remove('drag-over');
                const command = e.dataTransfer.getData('text/plain');
                if (command && !gameState.isExecuting) {
                    addToSequence(command);
                }
            });
        }

        function addToSequence(command) {
            gameState.sequence.push(command);
            updateSequenceDisplay();
        }

        window.removeFromSequence = function(index) {
            if (!gameState.isExecuting) {
                gameState.sequence.splice(index, 1);
                updateSequenceDisplay();
            }
        }

        function updateSequenceDisplay() {
            const sequenceArea = document.getElementById('sequenceArea');
            if (gameState.sequence.length === 0) {
                sequenceArea.innerHTML = '<div class="empty-sequence">å°‡æŒ‡ä»¤ç‰Œæ‹–æ›³åˆ°é€™è£¡</div>';
                return;
            }

            sequenceArea.innerHTML = '';
            gameState.sequence.forEach((command, index) => {
                const commandText = {
                    'A': 'å‰é€²ä¸€æ ¼',
                    'B': 'åŸåœ°å·¦è½‰', 
                    'C': 'å‰é€²ï¼›è‹¥å‰æ–¹æ²’è·¯å°±å·¦è½‰', 
                    'D': 'å‰é€²ï¼›è‹¥å‰æ–¹æ²’è·¯å°±å³è½‰'
                };
                
                const token = document.createElement('div');
                token.className = `sequence-token token-${command.toLowerCase()}`;
                token.innerHTML = `
                    <div>${command}</div>
                    <div style="font-size: 8px;">${commandText[command]}</div>
                    <button class="remove-btn" onclick="removeFromSequence(${index})">Ã—</button>
                `;
                sequenceArea.appendChild(token);
            });
        }
        
        async function executeAtomicCommand(command) {
              return new Promise(resolve => {
                  setTimeout(() => {
                      if (gameState.gameEnded) {
                          resolve();
                          return;
                      }
                      
                      let shouldMove = false;
                      let shouldTurn = false;
                      let turnDirection = null; 
                      
                      const frontPos = getFrontPosition();
                      // æª¢æŸ¥å‰æ–¹æ˜¯å¦æœ‰è·¯ï¼ˆé‚Šç•Œå…§ ä¸” ééšœç¤™ç‰©ï¼‰
                      const canMoveForward = isValidPosition(frontPos.x, frontPos.y); 
                      
                      // æª¢æŸ¥å‰æ–¹æ˜¯å¦ç‚ºé‚Šç•Œç‰† (ç”¨æ–¼æŒ‡ä»¤ A çš„å¤±æ•—åˆ¤æ–·)
                      const isWall = frontPos.x < 0 || frontPos.x >= MAZE_SIZE || frontPos.y < 0 || frontPos.y >= MAZE_SIZE;

                      switch (command) {
                          case 'A': // å‰é€²ä¸€æ ¼
                              if (canMoveForward) {
                                  shouldMove = true;
                              } else if (isWall) {
                                  // æ’åˆ°é‚Šç•Œç‰†ï¼ŒéŠæˆ²å¤±æ•—
                                  gameState.gameEnded = true;
                                  showResult(false, "æ’åˆ°é‚Šç•Œï¼ç§»å‹•å¤±æ•—ï¼");
                              } else {
                                  // æ’åˆ°éšœç¤™ç‰©ï¼Œåœåœ¨åŸåœ°ï¼ŒæŒ‡ä»¤ç„¡æ•ˆ
                              }
                              break;
                          case 'B': // åŸåœ°å·¦è½‰
                              shouldTurn = true;
                              turnDirection = 'left';
                              break;
                          // é¸æ“‡çµæ§‹æŒ‡ä»¤ C: å‰é€²ï¼›è‹¥å‰æ–¹æ²’è·¯å°±å·¦è½‰
                          case 'C': 
                              if (canMoveForward) {
                                  shouldMove = true; // å‰é€²
                              } else {
                                  shouldTurn = true; // å·¦è½‰
                                  turnDirection = 'left'; 
                              }
                              break;
                          // é¸æ“‡çµæ§‹æŒ‡ä»¤ D: å‰é€²ï¼›è‹¥å‰æ–¹æ²’è·¯å°±å³è½‰
                          case 'D': 
                              if (canMoveForward) {
                                  shouldMove = true; // å‰é€²
                              } else {
                                  shouldTurn = true; // å³è½‰
                                  turnDirection = 'right'; 
                              }
                              break;
                      }
                      
                      if (shouldMove) {
                           gameState.playerPos = frontPos;
                      }
                      
                      if (shouldTurn) {
                          if (turnDirection === 'left') {
                              // å·¦è½‰ (é€†æ™‚é‡)
                              gameState.playerDirection = (gameState.playerDirection + 3) % 4;
                              gameState.playerRotation -= 90; 
                          } else if (turnDirection === 'right') {
                              // å³è½‰ (é †æ™‚é‡)
                              gameState.playerDirection = (gameState.playerDirection + 1) % 4;
                              gameState.playerRotation += 90; 
                          }
                      }
                      
                      updatePlayerPosition();
                      
                      // æª¢æŸ¥æ˜¯å¦åˆ°é”å¯¶è—
                      if (!gameState.gameEnded && gameState.playerPos.x === TREASURE_POS.x && gameState.playerPos.y === TREASURE_POS.y) {
                          gameState.gameEnded = true;
                          const config = window.elementSdk?.config || defaultConfig;
                          showResult(true, config.success_message || defaultConfig.success_message);
                      }
                      
                      resolve();
                  }, 500); // æ¯æ¬¡åŸå­æ“ä½œå»¶é² 500ms
              });
        }
        
        async function executeSequence() {
            if (gameState.sequence.length === 0 || gameState.isExecuting) return;
            
            gameState.isExecuting = true;
            document.getElementById('executeBtn').disabled = true;
            document.getElementById('resultMessage').textContent = '';
            document.getElementById('resultMessage').className = 'result-message';

            for (let index = 0; index < gameState.sequence.length && !gameState.gameEnded; index++) {
                const command = gameState.sequence[index];
                await executeAtomicCommand(command);
            }
            
            gameState.isExecuting = false;
            document.getElementById('executeBtn').disabled = false;
            
            if (!gameState.gameEnded) {
                showResult(false, "æŒ‡ä»¤åŸ·è¡Œå®Œç•¢ï¼Œé‚„æ²’åˆ°é”å¯¶è—ï¼Œè©¦è©¦èª¿æ•´æŒ‡ä»¤åºåˆ—ï¼");
            }
        }

        function showResult(success, message) {
            const resultDiv = document.getElementById('resultMessage');
            resultDiv.textContent = message;
            resultDiv.className = `result-message ${success ? 'success' : 'failure'}`;
        }

        function resetGame() {
            gameState = {
                playerPos: { x: 2, y: 3 },
                playerDirection: 3,
                playerRotation: 0, 
                sequence: [],
                isExecuting: false,
                gameEnded: false
            };
            
            initMaze(); 
            updateSequenceDisplay();
            document.getElementById('resultMessage').textContent = '';
            document.getElementById('resultMessage').className = 'result-message';
            document.getElementById('executeBtn').disabled = false;
        }

        // --- äº‹ä»¶ç›£è½å™¨èˆ‡åˆå§‹åŒ– ---
        document.getElementById('executeBtn').addEventListener('click', executeSequence);
        document.getElementById('resetBtn').addEventListener('click', resetGame);

        document.addEventListener('DOMContentLoaded', () => {
            // ç¢ºä¿æ‰€æœ‰ DOM å…ƒç´ æº–å‚™å¥½
            
            // 1. åŸ·è¡Œåˆå§‹åŒ–ï¼ˆç¹ªè£½è¿·å®®ï¼‰
            initMaze();
            
            // 2. é‡ç½®éŠæˆ²ç‹€æ…‹è‡³åˆå§‹è¨­å®š
            resetGame();
            
            // 3. ç¶å®šæŒ‡ä»¤ç‰Œçš„é»æ“Šå’Œæ‹–æ›³äº‹ä»¶ (ç¢ºä¿å…ƒç´ å·²å­˜åœ¨ä¸”ç‹€æ…‹å·²é‡ç½®)
            setupDragAndDrop();
        });
    </script>
</body>
</html>
